<?xml version="1.0" encoding="UTF-8" ?>
<?demandware-pipeline version="2.0"?>

<pipeline type="view">
  <branch basename="_ANONYMOUS_BRANCH_1">
    <segment>
      <node>
        <text-node>
          <description>Performs Purchase Confirm Call and Authorrize Call</description>
        </text-node>
        <node-display x="1" y="0"/>
      </node>
    </segment>
  </branch>
  <branch basename="Data">
    <segment>
      <node>
        <start-node call-mode="private" name="Data" secure="false"/>
        <node-display x="1" y="1"/>
      </node>
      <simple-transition/>
      <node>
        <decision-node condition-key="PaymentInstrument.paymentTransaction.amount&gt;0" condition-operator="expr"/>
        <node-display x="0" y="1"/>
        <branch basename="b2" source-connector="yes">
          <transition target-connector="in">
            <transition-display>
              <bend-point relative-to="target" x="0" y="-1"/>
            </transition-display>
          </transition>
          <segment>
            <node>
              <call-node start-name-ref="CybersourceVme-ConfirmPurchase"/>
              <node-display x="0" y="2"/>
              <branch basename="b2" source-connector="error">
                <transition target-connector="in1"/>
                <segment>
                  <node>
                    <join-node/>
                    <node-display x="-1" y="2"/>
                  </node>
                  <simple-transition>
                    <transition-display>
                      <bend-point relative-to="source" x="0" y="1"/>
                    </transition-display>
                  </simple-transition>
                  <node>
                    <end-node name="error"/>
                    <node-display x="0" y="1"/>
                  </node>
                </segment>
              </branch>
              <branch basename="b3" source-connector="authorized">
                <transition target-connector="in">
                  <transition-display>
                    <bend-point relative-to="source" x="0" y="1"/>
                  </transition-display>
                </transition>
                <segment>
                  <node>
                    <call-node start-name-ref="CybersourceVme-Authorize"/>
                    <node-display x="0" y="1"/>
                    <branch basename="b2" source-connector="error">
                      <transition target-connector="in1" target-path="../b2.1"/>
                    </branch>
                    <branch basename="b3" source-connector="authorized">
                      <transition target-connector="in"/>
                      <segment>
                        <node>
                          <end-node name="authorized"/>
                          <node-display x="0" y="2"/>
                        </node>
                      </segment>
                    </branch>
                    <branch basename="b4" source-connector="declined">
                      <transition target-connector="in1"/>
                      <segment>
                        <node>
                          <join-node/>
                          <node-display x="1" y="1"/>
                        </node>
                        <simple-transition>
                          <transition-display>
                            <bend-point relative-to="source" x="0" y="1"/>
                          </transition-display>
                        </simple-transition>
                        <node>
                          <end-node name="declined"/>
                          <node-display x="0" y="1"/>
                        </node>
                      </segment>
                    </branch>
                    <branch basename="b5" source-connector="review">
                      <transition target-connector="in1"/>
                      <segment>
                        <node>
                          <join-node/>
                          <node-display x="2" y="1"/>
                        </node>
                        <simple-transition>
                          <transition-display>
                            <bend-point relative-to="source" x="0" y="1"/>
                          </transition-display>
                        </simple-transition>
                        <node>
                          <end-node name="review"/>
                          <node-display x="0" y="1"/>
                        </node>
                      </segment>
                    </branch>
                  </node>
                </segment>
              </branch>
              <branch basename="b4" source-connector="declined">
                <transition target-connector="in1" target-path="./b3.1/b4.1"/>
              </branch>
              <branch basename="b5" source-connector="review">
                <transition target-connector="in1" target-path="./b3.1/b5.1"/>
              </branch>
            </node>
          </segment>
        </branch>
      </node>
      <simple-transition>
        <transition-display>
          <bend-point relative-to="source" x="1" y="0"/>
        </transition-display>
      </simple-transition>
      <node>
        <end-node name="authorized"/>
        <node-display orientation="horizontal" x="1" y="0"/>
      </node>
    </segment>
  </branch>
  <branch basename="_ANONYMOUS_BRANCH_3">
    <segment>
      <node>
        <text-node>
          <description>This pipeline is used to call get checkout details service to V.me via Cybersource. Used by CoShippingVisa pipeline</description>
        </text-node>
        <node-display x="4" y="0"/>
      </node>
    </segment>
  </branch>
  <branch basename="GetCheckoutDetails">
    <segment>
      <node>
        <start-node call-mode="private" name="GetCheckoutDetails" secure="false"/>
        <node-display x="4" y="1"/>
      </node>
      <simple-transition>
        <transition-display>
          <bend-point relative-to="source" x="0" y="1"/>
        </transition-display>
      </simple-transition>
      <node>
        <pipelet-node pipelet-name="Script" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="false"/>
          <config-property key="OnError" value="PIPELET_ERROR"/>
          <config-property key="ScriptFile" value="cybersource/AP/CreateCybersourceAPObject.ds"/>
          <key-binding alias="log" key="ScriptLog"/>
          <key-binding alias="CybersourceAPObject" key="CybersourceAPObject"/>
          <key-binding alias="CurrentForms.vMeBilling.callId.htmlValue" key="orderID"/>
          <key-binding alias="Basket" key="Basket"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
        <branch basename="b2" source-connector="error">
          <transition target-connector="in1" target-path="./+1">
            <transition-display>
              <bend-point relative-to="source" x="2" y="0"/>
            </transition-display>
          </transition>
        </branch>
      </node>
      <simple-transition>
        <transition-display>
          <bend-point relative-to="source" x="0" y="1"/>
        </transition-display>
      </simple-transition>
      <node>
        <pipelet-node pipelet-name="Script" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="false"/>
          <config-property key="OnError" value="PIPELET_ERROR"/>
          <config-property key="ScriptFile" value="cybersource/PurchaseTotals/CreateCybersourcePurchaseTotalsObject.ds"/>
          <key-binding alias="log" key="ScriptLog"/>
          <key-binding alias="CyberSourcePurchaseTotals" key="CyberSourcePurchaseTotals"/>
          <key-binding alias="CyberSourcePurchaseTotals" key="CybersourcePurchaseTotals"/>
          <key-binding alias="Basket" key="Basket"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
        <branch basename="b3" source-connector="error">
          <transition target-connector="in2" target-path="./+1"/>
        </branch>
      </node>
      <simple-transition>
        <transition-display>
          <bend-point relative-to="source" x="0" y="1"/>
        </transition-display>
      </simple-transition>
      <node>
        <pipelet-node pipelet-name="Script" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="false"/>
          <config-property key="OnError" value="PIPELET_ERROR"/>
          <config-property key="ScriptFile" value="cybersource/VmeGetCheckoutDetails.ds"/>
          <key-binding alias="log" key="ScriptLog"/>
          <key-binding alias="ReasonCode" key="ReasonCode"/>
          <key-binding alias="authreason" key="AuthorizationReasonCode"/>
          <key-binding alias="authamount" key="AuthorizationAmount"/>
          <key-binding alias="authcode" key="AuthorizationCode"/>
          <key-binding alias="descision" key="Decision"/>
          <key-binding alias="requestid" key="RequestID"/>
          <key-binding alias="token" key="RequestToken"/>
          <key-binding alias="CybersourceBillTo" key="billTo"/>
          <key-binding alias="CybersourcePaymentCard" key="card"/>
          <key-binding alias="CyberSourcePurchaseTotals" key="purchaseTotals"/>
          <key-binding alias="CybersourceShipTo" key="shipTo"/>
          <key-binding alias="AVSCode" key="AVSCode"/>
          <key-binding alias="AVSCodeRaw" key="AVSCodeRaw"/>
          <key-binding alias="DAVReasonCode" key="DAVReasonCode"/>
          <key-binding alias="CybersourceAPObject" key="apObject"/>
          <key-binding alias="apAdditionalAmount" key="apAdditionalAmount"/>
          <key-binding alias="apCheckoutReplyReasonCode" key="apCheckoutReplyReasonCode"/>
          <key-binding alias="apCheckoutReplyStatus" key="apCheckoutReplySatatus"/>
          <key-binding alias="apCheckoutReplyStatus" key="apCheckoutReplyStatus"/>
          <key-binding alias="apDiscountAmt" key="apDiscountAmt"/>
          <key-binding alias="apGiftWrapAmt" key="apGiftWrapAmt"/>
          <key-binding alias="apHandlingAmount" key="apHandlingAmount"/>
          <key-binding alias="apOrderID" key="apOrderID"/>
          <key-binding alias="apProductDescription" key="apProductDescription"/>
          <key-binding alias="apProductID" key="apProductID"/>
          <key-binding alias="apPurchaseAmount" key="apPurchaseAmount"/>
          <key-binding alias="apPurchaseID" key="apPurchaseID"/>
          <key-binding alias="apShippingAmount" key="apShippingAmount"/>
          <key-binding alias="apShippingHandlingAmount" key="apShippingHandlingAmount"/>
          <key-binding alias="apSubtotalAmount" key="apSubtotalAmount"/>
          <key-binding alias="apTaxAmount" key="apTaxAmount"/>
          <key-binding alias="dateTime" key="dateTime"/>
          <key-binding alias="processorResponse" key="processorResponse"/>
          <key-binding alias="apReasonCode" key="apReasonCode"/>
          <key-binding alias="apStatus" key="apStatus"/>
          <key-binding alias="city" key="city"/>
          <key-binding alias="country" key="country"/>
          <key-binding alias="email" key="email"/>
          <key-binding alias="name" key="name"/>
          <key-binding alias="postalCode" key="postalCode"/>
          <key-binding alias="state" key="state"/>
          <key-binding alias="street1" key="street1"/>
          <key-binding alias="street2" key="street2"/>
          <key-binding alias="Basket" key="Basket"/>
          <key-binding alias="CheckoutDetailObject" key="CheckoutDetailObject"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
        <branch basename="b4" source-connector="error">
          <transition target-connector="in1" target-path="./+1">
            <transition-display>
              <bend-point relative-to="source" x="2" y="0"/>
            </transition-display>
          </transition>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <decision-node condition-key="ReasonCode==100" condition-operator="expr"/>
        <node-display x="0" y="1"/>
        <branch basename="b5" source-connector="yes">
          <transition target-connector="in"/>
          <segment>
            <node>
              <end-node name="Ok"/>
              <node-display x="0" y="1"/>
            </node>
          </segment>
        </branch>
      </node>
      <transition target-connector="in1" target-path="./+1">
        <transition-display>
          <bend-point relative-to="source" x="2" y="0"/>
        </transition-display>
      </transition>
    </segment>
    <segment>
      <node>
        <join-node/>
        <node-display x="1" y="-2"/>
      </node>
      <simple-transition>
        <transition-display>
          <bend-point relative-to="source" x="1" y="0"/>
        </transition-display>
      </simple-transition>
      <node>
        <end-node name="error"/>
        <node-display orientation="horizontal" x="1" y="0"/>
      </node>
    </segment>
  </branch>
  <branch basename="_ANONYMOUS_BRANCH_5">
    <segment>
      <node>
        <text-node>
          <description>Performs the confirmation of purchase  for V.me</description>
        </text-node>
        <node-display x="8" y="0"/>
      </node>
    </segment>
  </branch>
  <branch basename="ConfirmPurchase">
    <segment>
      <node>
        <start-node call-mode="private" name="ConfirmPurchase" secure="false"/>
        <node-display x="8" y="1"/>
      </node>
      <simple-transition>
        <transition-display>
          <bend-point relative-to="source" x="0" y="1"/>
        </transition-display>
      </simple-transition>
      <node>
        <pipelet-node pipelet-name="Script" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="false"/>
          <config-property key="OnError" value="PIPELET_ERROR"/>
          <config-property key="ScriptFile" value="cybersource/AP/CreateCybersourceAPObject.ds"/>
          <key-binding alias="log" key="ScriptLog"/>
          <key-binding alias="CybersourceAPObject" key="CybersourceAPObject"/>
          <key-binding alias="CurrentForms.vMeBilling.callId.htmlValue" key="orderID"/>
          <key-binding alias="CheckoutDetailObject" key="CheckoutDetailObject"/>
          <key-binding alias="Basket" key="Basket"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
        <branch basename="b2" source-connector="error">
          <transition target-connector="in1" target-path="./b4.1">
            <transition-display>
              <bend-point relative-to="source" x="2" y="0"/>
            </transition-display>
          </transition>
        </branch>
      </node>
      <simple-transition>
        <transition-display>
          <bend-point relative-to="source" x="0" y="1"/>
        </transition-display>
      </simple-transition>
      <node>
        <pipelet-node pipelet-name="Script" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="false"/>
          <config-property key="OnError" value="PIPELET_ERROR"/>
          <config-property key="ScriptFile" value="cybersource/PurchaseTotals/CreateCybersourcePurchaseTotalsObject.ds"/>
          <key-binding alias="log" key="ScriptLog"/>
          <key-binding alias="CyberSourcePurchaseTotals" key="CyberSourcePurchaseTotals"/>
          <key-binding alias="CybersourcePurchaseTotals" key="CybersourcePurchaseTotals"/>
          <key-binding alias="Basket" key="Basket"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
        <branch basename="b3" source-connector="error">
          <transition target-connector="in2" target-path="./b4.1"/>
        </branch>
      </node>
      <simple-transition>
        <transition-display>
          <bend-point relative-to="source" x="0" y="1"/>
        </transition-display>
      </simple-transition>
      <node>
        <pipelet-node pipelet-name="Script" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="false"/>
          <config-property key="OnError" value="PIPELET_ERROR"/>
          <config-property key="ScriptFile" value="cybersource/VmeConfirmPurchaseRequest.ds"/>
          <key-binding alias="log" key="ScriptLog"/>
          <key-binding alias="CybersourceAPObject" key="apObject"/>
          <key-binding alias="Basket" key="Basket"/>
          <key-binding alias="CyberSourcePurchaseTotals" key="purchaseTotals"/>
          <key-binding alias="apReasonCode" key="apReasonCode"/>
          <key-binding alias="Decision" key="Decision"/>
          <key-binding alias="ReasonCode" key="ReasonCode"/>
          <key-binding alias="RequestID" key="RequestID"/>
          <key-binding alias="RequestToken" key="RequestToken"/>
          <key-binding alias="response" key="response"/>
          <key-binding alias="!empty(OrderNo)?OrderNo:Order.orderNo" key="OrderNo"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
        <branch basename="b4" source-connector="error">
          <transition target-connector="in1">
            <transition-display>
              <bend-point relative-to="source" x="2" y="0"/>
            </transition-display>
          </transition>
          <segment>
            <node>
              <join-node/>
              <node-display x="1" y="-1"/>
            </node>
            <simple-transition>
              <transition-display>
                <bend-point relative-to="source" x="1" y="0"/>
              </transition-display>
            </simple-transition>
            <node>
              <end-node name="error"/>
              <node-display orientation="horizontal" x="1" y="0"/>
            </node>
          </segment>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <decision-node condition-key="ReasonCode == 100" condition-operator="expr">
          <description>Successful transaction.</description>
        </decision-node>
        <node-display orientation="horizontal" x="0" y="1"/>
        <branch basename="b5" source-connector="yes">
          <transition target-connector="in">
            <transition-display>
              <bend-point relative-to="target" x="-1" y="0"/>
            </transition-display>
          </transition>
          <segment>
            <node>
              <pipelet-node pipelet-name="Assign" pipelet-set-identifier="bc_api">
                <config-property key="Transactional" value="true"/>
                <key-binding alias="RequestID + &quot;-&quot; + PaymentInstrument.paymentTransaction.transactionID" key="From_0"/>
                <key-binding alias="PaymentInstrument.paymentTransaction.transactionID" key="To_0"/>
                <key-binding alias="null" key="From_1"/>
                <key-binding alias="null" key="To_1"/>
                <key-binding alias="null" key="From_2"/>
                <key-binding alias="null" key="To_2"/>
                <key-binding alias="null" key="From_3"/>
                <key-binding alias="null" key="To_3"/>
                <key-binding alias="null" key="From_4"/>
                <key-binding alias="null" key="To_4"/>
                <key-binding alias="null" key="From_5"/>
                <key-binding alias="null" key="To_5"/>
                <key-binding alias="null" key="From_6"/>
                <key-binding alias="null" key="To_6"/>
                <key-binding alias="null" key="From_7"/>
                <key-binding alias="null" key="To_7"/>
                <key-binding alias="null" key="From_8"/>
                <key-binding alias="null" key="To_8"/>
                <key-binding alias="null" key="From_9"/>
                <key-binding alias="null" key="To_9"/>
              </pipelet-node>
              <node-display orientation="horizontal" x="2" y="0"/>
            </node>
            <simple-transition>
              <transition-display>
                <bend-point relative-to="source" x="1" y="0"/>
              </transition-display>
            </simple-transition>
            <node>
              <end-node name="authorized"/>
              <node-display orientation="horizontal" x="1" y="0"/>
            </node>
          </segment>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <decision-node condition-key="ReasonCode == 203 || ReasonCode == 237 || ReasonCode == 242 || ReasonCode == 255" condition-operator="expr"/>
        <node-display orientation="horizontal" x="0" y="1"/>
        <branch basename="b6" source-connector="yes">
          <transition target-connector="in">
            <transition-display>
              <bend-point relative-to="target" x="-1" y="0"/>
            </transition-display>
          </transition>
          <segment>
            <node>
              <pipelet-node pipelet-name="Assign" pipelet-set-identifier="bc_api">
                <config-property key="Transactional" value="true"/>
                <key-binding alias="RequestID + &quot;-&quot; + PaymentInstrument.paymentTransaction.transactionID" key="From_0"/>
                <key-binding alias="PaymentInstrument.paymentTransaction.transactionID" key="To_0"/>
                <key-binding alias="null" key="From_2"/>
                <key-binding alias="null" key="To_2"/>
                <key-binding alias="null" key="From_3"/>
                <key-binding alias="null" key="To_3"/>
                <key-binding alias="null" key="From_4"/>
                <key-binding alias="null" key="To_4"/>
                <key-binding alias="null" key="From_5"/>
                <key-binding alias="null" key="To_5"/>
                <key-binding alias="null" key="From_6"/>
                <key-binding alias="null" key="To_6"/>
                <key-binding alias="null" key="From_7"/>
                <key-binding alias="null" key="To_7"/>
                <key-binding alias="null" key="From_8"/>
                <key-binding alias="null" key="To_8"/>
                <key-binding alias="null" key="From_9"/>
                <key-binding alias="null" key="To_9"/>
              </pipelet-node>
              <node-display orientation="horizontal" x="2" y="0"/>
            </node>
            <simple-transition>
              <transition-display>
                <bend-point relative-to="source" x="1" y="0"/>
              </transition-display>
            </simple-transition>
            <node>
              <end-node name="declined"/>
              <node-display orientation="horizontal" x="1" y="0"/>
            </node>
          </segment>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <decision-node condition-key="ReasonCode == 101 || ReasonCode == 102 || ReasonCode == 150 || ReasonCode == 233" condition-operator="expr"/>
        <node-display x="0" y="1"/>
        <branch basename="b7" source-connector="yes">
          <transition target-connector="in2" target-path="./b8.1"/>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <decision-node condition-key="ReasonCode == 999" condition-operator="expr">
          <description>When cybersource request timesout</description>
        </decision-node>
        <node-display orientation="horizontal" x="0" y="1"/>
        <branch basename="b8" source-connector="yes">
          <transition target-connector="in1"/>
          <segment>
            <node>
              <join-node/>
              <node-display x="1" y="0"/>
            </node>
            <simple-transition/>
            <node>
              <pipelet-node pipelet-name="Assign" pipelet-set-identifier="bc_api">
                <config-property key="Transactional" value="true"/>
                <key-binding alias="RequestID + &quot;-&quot; + PaymentInstrument.paymentTransaction.transactionID" key="From_0"/>
                <key-binding alias="PaymentInstrument.paymentTransaction.transactionID" key="To_0"/>
                <key-binding alias="null" key="From_2"/>
                <key-binding alias="null" key="To_2"/>
                <key-binding alias="null" key="From_3"/>
                <key-binding alias="null" key="To_3"/>
                <key-binding alias="null" key="From_4"/>
                <key-binding alias="null" key="To_4"/>
                <key-binding alias="null" key="From_5"/>
                <key-binding alias="null" key="To_5"/>
                <key-binding alias="null" key="From_6"/>
                <key-binding alias="null" key="To_6"/>
                <key-binding alias="null" key="From_7"/>
                <key-binding alias="null" key="To_7"/>
                <key-binding alias="null" key="From_8"/>
                <key-binding alias="null" key="To_8"/>
                <key-binding alias="null" key="From_9"/>
                <key-binding alias="null" key="To_9"/>
              </pipelet-node>
              <node-display orientation="horizontal" x="1" y="0"/>
            </node>
            <simple-transition>
              <transition-display>
                <bend-point relative-to="source" x="1" y="0"/>
              </transition-display>
            </simple-transition>
            <node>
              <end-node name="error"/>
              <node-display orientation="horizontal" x="1" y="0"/>
            </node>
          </segment>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <pipelet-node pipelet-name="Assign" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="true"/>
          <key-binding alias="RequestID + &quot;-&quot; + PaymentInstrument.paymentTransaction.transactionID" key="From_0"/>
          <key-binding alias="PaymentInstrument.paymentTransaction.transactionID" key="To_0"/>
          <key-binding alias="null" key="From_2"/>
          <key-binding alias="null" key="To_2"/>
          <key-binding alias="null" key="From_3"/>
          <key-binding alias="null" key="To_3"/>
          <key-binding alias="null" key="From_4"/>
          <key-binding alias="null" key="To_4"/>
          <key-binding alias="null" key="From_5"/>
          <key-binding alias="null" key="To_5"/>
          <key-binding alias="null" key="From_6"/>
          <key-binding alias="null" key="To_6"/>
          <key-binding alias="null" key="From_7"/>
          <key-binding alias="null" key="To_7"/>
          <key-binding alias="null" key="From_8"/>
          <key-binding alias="null" key="To_8"/>
          <key-binding alias="null" key="From_9"/>
          <key-binding alias="null" key="To_9"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
      </node>
      <simple-transition/>
      <node>
        <end-node name="declined"/>
        <node-display x="0" y="1"/>
      </node>
    </segment>
  </branch>
  <branch basename="_ANONYMOUS_BRANCH_7">
    <segment>
      <node>
        <text-node>
          <description>Reason Codes for confirm purchase &amp; auth service
100 Successful transaction.
101 Missing required fields.
102 Invalid data.
150 General system failure.
203 Declined by issuer or V.me.
233 Error caused by one of the following conditions:
&#61548; Authentication error
&#61548; Fraud check failure
&#61548; General decline by V.me
&#61548; Invalid input
&#61548; Invalid order status
&#61548; Invalid transaction status
&#61548; Order not found
&#61548; Requested amount exceeds amount available in customer&#8217;s account
&#61548; Requested amount exceeds transaction amount
&#61548; Total amount does not match computed total
&#61548; Transaction not found
&#61548; Unsupported currency
237 Two different conditions can cause this reason code.
&#61550; General decline by V.me or fraud check failure.
Possible action: Request a different card or other form of payment.
&#61550; Transaction already requested.
Possible action: No action required.
242 No valid corresponding authorization. The request to reverse or capture an
authorization refers to an authorization that does not exist or that has already been
reversed or captured.
255 Unsupported currency.
999 Cybersource Server Timeout.</description>
        </text-node>
        <node-display height="4" width="2" x="11" y="1"/>
      </node>
    </segment>
  </branch>
  <branch basename="_ANONYMOUS_BRANCH_8">
    <segment>
      <node>
        <text-node>
          <description>Performs the Authorization for Confirmed Purchase for V.me via Cybersource</description>
        </text-node>
        <node-display x="13" y="0"/>
      </node>
    </segment>
  </branch>
  <branch basename="Authorize">
    <segment>
      <node>
        <start-node call-mode="private" name="Authorize" secure="false"/>
        <node-display x="13" y="1"/>
      </node>
      <simple-transition>
        <transition-display>
          <bend-point relative-to="source" x="0" y="1"/>
        </transition-display>
      </simple-transition>
      <node>
        <pipelet-node pipelet-name="Script" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="false"/>
          <config-property key="OnError" value="PIPELET_ERROR"/>
          <config-property key="ScriptFile" value="cybersource/AP/CreateCybersourceAPObject.ds"/>
          <key-binding alias="log" key="ScriptLog"/>
          <key-binding alias="CybersourceAPObject" key="CybersourceAPObject"/>
          <key-binding alias="CurrentForms.vMeBilling.callId.htmlValue" key="orderID"/>
          <key-binding alias="Basket" key="Basket"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
        <branch basename="b2" source-connector="error">
          <transition target-connector="in1" target-path="./b4.1">
            <transition-display>
              <bend-point relative-to="source" x="2" y="0"/>
            </transition-display>
          </transition>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <pipelet-node pipelet-name="Script" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="false"/>
          <config-property key="OnError" value="PIPELET_ERROR"/>
          <config-property key="ScriptFile" value="cybersource/PurchaseTotals/CreateCybersourcePurchaseTotalsObject.ds"/>
          <key-binding alias="log" key="ScriptLog"/>
          <key-binding alias="CyberSourcePurchaseTotals" key="CyberSourcePurchaseTotals"/>
          <key-binding alias="Basket" key="Basket"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
        <branch basename="b3" source-connector="error">
          <transition target-connector="in2" target-path="./b4.1"/>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <pipelet-node pipelet-name="Script" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="false"/>
          <config-property key="OnError" value="PIPELET_ERROR"/>
          <config-property key="ScriptFile" value="cybersource/VmeAuthorize.ds"/>
          <key-binding alias="log" key="ScriptLog"/>
          <key-binding alias="ReasonCode" key="ReasonCode"/>
          <key-binding alias="authreason" key="AuthorizationReasonCode"/>
          <key-binding alias="AuthorizationAmount" key="AuthorizationAmount"/>
          <key-binding alias="authcode" key="AuthorizationCode"/>
          <key-binding alias="Descision" key="Decision"/>
          <key-binding alias="RequestID" key="RequestID"/>
          <key-binding alias="RequestToken" key="RequestToken"/>
          <key-binding alias="CybersourceBillTo" key="billTo"/>
          <key-binding alias="CybersourcePaymentCard" key="card"/>
          <key-binding alias="CyberSourcePurchaseTotals" key="purchaseTotals"/>
          <key-binding alias="CybersourceShipTo" key="shipTo"/>
          <key-binding alias="AVSCode" key="AVSCode"/>
          <key-binding alias="AVSCodeRaw" key="AVSCodeRaw"/>
          <key-binding alias="DAVReasonCode" key="DAVReasonCode"/>
          <key-binding alias="CybersourceAPObject" key="apObject"/>
          <key-binding alias="apReasonCode" key="apReasonCode"/>
          <key-binding alias="apStatus" key="apStatus"/>
          <key-binding alias="cardExpirationMonth" key="cardExpirationMonth"/>
          <key-binding alias="cardExpirationYear" key="cardExpirationYear"/>
          <key-binding alias="cardGroup" key="cardGroup"/>
          <key-binding alias="cardNumberSuffix" key="cardNumberSuffix"/>
          <key-binding alias="cardType" key="cardType"/>
          <key-binding alias="dateTime" key="dateTime"/>
          <key-binding alias="processorResponse" key="processorResponse"/>
          <key-binding alias="purchaseTotalCurrency" key="purchaseTotalCurrency"/>
          <key-binding alias="transactionID" key="transactionID"/>
          <key-binding alias="Basket" key="Basket"/>
          <key-binding alias="name" key="name"/>
          <key-binding alias="phoneNumber" key="phoneNumber"/>
          <key-binding alias="Name" key="Name"/>
          <key-binding alias="PhoneNumber" key="PhoneNumber"/>
          <key-binding alias="TransactionID" key="TransactionID"/>
          <key-binding alias="FirstName" key="FirstName"/>
          <key-binding alias="LastName" key="LastName"/>
          <key-binding alias="RiskIndicator" key="RiskIndicator"/>
          <key-binding alias="!empty(OrderNo)?OrderNo:Order.orderNo" key="OrderNo"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
        <branch basename="b4" source-connector="error">
          <transition target-connector="in1">
            <transition-display>
              <bend-point relative-to="source" x="2" y="0"/>
            </transition-display>
          </transition>
          <segment>
            <node>
              <join-node/>
              <node-display x="1" y="-1"/>
            </node>
            <simple-transition>
              <transition-display>
                <bend-point relative-to="source" x="1" y="0"/>
              </transition-display>
            </simple-transition>
            <node>
              <end-node name="error"/>
              <node-display orientation="horizontal" x="1" y="0"/>
            </node>
          </segment>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <decision-node condition-key="ReasonCode ==100" condition-operator="expr"/>
        <node-display orientation="horizontal" x="0" y="1"/>
        <branch basename="b5" source-connector="yes">
          <transition target-connector="in">
            <transition-display>
              <bend-point relative-to="source" x="1" y="0"/>
            </transition-display>
          </transition>
          <segment>
            <node>
              <pipelet-node pipelet-name="Assign" pipelet-set-identifier="bc_api">
                <config-property key="Transactional" value="true"/>
                <key-binding alias="PaymentInstrument.paymentTransaction.transactionID + &quot;-&quot; + TransactionID + &quot;-&quot; + RiskIndicator" key="From_0"/>
                <key-binding alias="PaymentInstrument.paymentTransaction.transactionID" key="To_0"/>
                <key-binding alias="null" key="From_5"/>
                <key-binding alias="null" key="To_5"/>
                <key-binding alias="null" key="From_6"/>
                <key-binding alias="null" key="To_6"/>
                <key-binding alias="null" key="From_7"/>
                <key-binding alias="null" key="To_7"/>
                <key-binding alias="null" key="From_8"/>
                <key-binding alias="null" key="To_8"/>
                <key-binding alias="null" key="From_9"/>
                <key-binding alias="null" key="To_9"/>
                <key-binding alias="Basket.billingAddress.firstName" key="To_1"/>
                <key-binding alias="Basket.billingAddress.lastName" key="To_2"/>
                <key-binding alias="Basket.billingAddress.phone" key="To_3"/>
                <key-binding alias="FirstName" key="From_1"/>
                <key-binding alias="LastName" key="From_2"/>
                <key-binding alias="PhoneNumber" key="From_3"/>
              </pipelet-node>
              <node-display orientation="horizontal" x="1" y="0"/>
            </node>
            <simple-transition>
              <transition-display>
                <bend-point relative-to="source" x="1" y="0"/>
              </transition-display>
            </simple-transition>
            <node>
              <end-node name="authorized"/>
              <node-display orientation="horizontal" x="1" y="0"/>
            </node>
          </segment>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <decision-node condition-key="ReasonCode == 203 || ReasonCode == 237 || ReasonCode == 242 || ReasonCode == 255" condition-operator="expr"/>
        <node-display orientation="horizontal" x="0" y="1"/>
        <branch basename="b6" source-connector="yes">
          <transition target-connector="in">
            <transition-display>
              <bend-point relative-to="target" x="-1" y="0"/>
            </transition-display>
          </transition>
          <segment>
            <node>
              <pipelet-node pipelet-name="Assign" pipelet-set-identifier="bc_api">
                <config-property key="Transactional" value="true"/>
                <key-binding alias="PaymentInstrument.paymentTransaction.transactionID + &quot;-&quot; + TransactionID + &quot;-&quot; + RiskIndicator" key="From_0"/>
                <key-binding alias="PaymentInstrument.paymentTransaction.transactionID" key="To_0"/>
                <key-binding alias="null" key="From_3"/>
                <key-binding alias="null" key="To_3"/>
                <key-binding alias="null" key="From_4"/>
                <key-binding alias="null" key="To_4"/>
                <key-binding alias="null" key="From_5"/>
                <key-binding alias="null" key="To_5"/>
                <key-binding alias="null" key="From_6"/>
                <key-binding alias="null" key="To_6"/>
                <key-binding alias="null" key="From_7"/>
                <key-binding alias="null" key="To_7"/>
                <key-binding alias="null" key="From_8"/>
                <key-binding alias="null" key="To_8"/>
                <key-binding alias="null" key="From_9"/>
                <key-binding alias="null" key="To_9"/>
              </pipelet-node>
              <node-display orientation="horizontal" x="2" y="0"/>
            </node>
            <simple-transition>
              <transition-display>
                <bend-point relative-to="source" x="1" y="0"/>
              </transition-display>
            </simple-transition>
            <node>
              <end-node name="declined"/>
              <node-display orientation="horizontal" x="1" y="0"/>
            </node>
          </segment>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <decision-node condition-key="ReasonCode == 101 || ReasonCode == 102 || ReasonCode == 150 || ReasonCode == 233" condition-operator="expr"/>
        <node-display x="0" y="1"/>
        <branch basename="b7" source-connector="yes">
          <transition target-connector="in2" target-path="./b8.1"/>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <decision-node condition-key="ReasonCode == 999" condition-operator="expr">
          <description>When cybersource request timesout</description>
        </decision-node>
        <node-display orientation="horizontal" x="0" y="1"/>
        <branch basename="b8" source-connector="yes">
          <transition target-connector="in1"/>
          <segment>
            <node>
              <join-node/>
              <node-display x="1" y="0"/>
            </node>
            <simple-transition/>
            <node>
              <pipelet-node pipelet-name="Assign" pipelet-set-identifier="bc_api">
                <config-property key="Transactional" value="true"/>
                <key-binding alias="PaymentInstrument.paymentTransaction.transactionID + &quot;-&quot; + TransactionID + &quot;-&quot; + RiskIndicator" key="From_0"/>
                <key-binding alias="PaymentInstrument.paymentTransaction.transactionID" key="To_0"/>
                <key-binding alias="null" key="From_2"/>
                <key-binding alias="null" key="To_2"/>
                <key-binding alias="null" key="From_3"/>
                <key-binding alias="null" key="To_3"/>
                <key-binding alias="null" key="From_4"/>
                <key-binding alias="null" key="To_4"/>
                <key-binding alias="null" key="From_5"/>
                <key-binding alias="null" key="To_5"/>
                <key-binding alias="null" key="From_6"/>
                <key-binding alias="null" key="To_6"/>
                <key-binding alias="null" key="From_7"/>
                <key-binding alias="null" key="To_7"/>
                <key-binding alias="null" key="From_8"/>
                <key-binding alias="null" key="To_8"/>
                <key-binding alias="null" key="From_9"/>
                <key-binding alias="null" key="To_9"/>
              </pipelet-node>
              <node-display orientation="horizontal" x="1" y="0"/>
            </node>
            <simple-transition>
              <transition-display>
                <bend-point relative-to="source" x="1" y="0"/>
              </transition-display>
            </simple-transition>
            <node>
              <end-node name="error"/>
              <node-display orientation="horizontal" x="1" y="0"/>
            </node>
          </segment>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <pipelet-node pipelet-name="Assign" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="true"/>
          <key-binding alias="PaymentInstrument.paymentTransaction.transactionID + &quot;-&quot; + TransactionID + &quot;-&quot; + RiskIndicator" key="From_0"/>
          <key-binding alias="PaymentInstrument.paymentTransaction.transactionID" key="To_0"/>
          <key-binding alias="null" key="From_3"/>
          <key-binding alias="null" key="To_3"/>
          <key-binding alias="null" key="From_4"/>
          <key-binding alias="null" key="To_4"/>
          <key-binding alias="null" key="From_5"/>
          <key-binding alias="null" key="To_5"/>
          <key-binding alias="null" key="From_6"/>
          <key-binding alias="null" key="To_6"/>
          <key-binding alias="null" key="From_7"/>
          <key-binding alias="null" key="To_7"/>
          <key-binding alias="null" key="From_8"/>
          <key-binding alias="null" key="To_8"/>
          <key-binding alias="null" key="From_9"/>
          <key-binding alias="null" key="To_9"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
      </node>
      <simple-transition/>
      <node>
        <end-node name="declined"/>
        <node-display x="0" y="1"/>
      </node>
    </segment>
  </branch>
  <branch basename="_ANONYMOUS_BRANCH_10">
    <segment>
      <node>
        <text-node>
          <description>Initiate the Service for V.me for purchase confirm service and authorize service of V.me</description>
        </text-node>
        <node-display x="18" y="0"/>
      </node>
    </segment>
  </branch>
  <branch basename="InitiateService">
    <segment>
      <node>
        <start-node call-mode="private" name="InitiateService" secure="false"/>
        <node-display x="18" y="1"/>
      </node>
      <simple-transition>
        <transition-display>
          <bend-point relative-to="source" x="0" y="1"/>
        </transition-display>
      </simple-transition>
      <node>
        <pipelet-node pipelet-name="Script" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="false"/>
          <config-property key="OnError" value="PIPELET_ERROR"/>
          <config-property key="ScriptFile" value="cybersource/AP/CreateCybersourceAPObjectInitiate.ds"/>
          <key-binding alias="log" key="ScriptLog"/>
          <key-binding alias="CybersourceAPObject" key="CybersourceAPObject"/>
          <key-binding alias="CurrentForms.vMeBilling.callId.htmlValue" key="orderID"/>
          <key-binding alias="Basket" key="basket"/>
          <key-binding alias="Basket" key="Basket"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
        <branch basename="b2" source-connector="error">
          <transition target-connector="in2" target-path="./+1">
            <transition-display>
              <bend-point relative-to="source" x="2" y="0"/>
            </transition-display>
          </transition>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <pipelet-node pipelet-name="Script" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="false"/>
          <config-property key="OnError" value="PIPELET_ERROR"/>
          <config-property key="ScriptFile" value="cybersource/PurchaseTotals/CreateCybersourcePurchaseTotalsObjectInitiate.ds"/>
          <key-binding alias="log" key="ScriptLog"/>
          <key-binding alias="CyberSourcePurchaseTotals" key="CyberSourcePurchaseTotals"/>
          <key-binding alias="Basket" key="Basket"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
        <branch basename="b3" source-connector="error">
          <transition target-connector="in1" target-path="./+1">
            <transition-display>
              <bend-point relative-to="source" x="2" y="0"/>
            </transition-display>
          </transition>
        </branch>
      </node>
      <simple-transition/>
      <node>
        <pipelet-node pipelet-name="Script" pipelet-set-identifier="bc_api">
          <config-property key="Transactional" value="false"/>
          <config-property key="OnError" value="PIPELET_ERROR"/>
          <config-property key="ScriptFile" value="cybersource/VmeInitiateService.ds"/>
          <key-binding alias="log" key="ScriptLog"/>
          <key-binding alias="CybersourceAPObject" key="apObject"/>
          <key-binding alias="Basket" key="basket"/>
          <key-binding alias="CyberSourcePurchaseTotals" key="purchaseTotals"/>
          <key-binding alias="Decision" key="Decision"/>
          <key-binding alias="processorResponse" key="processorResponse"/>
          <key-binding alias="ReasonCode" key="ReasonCode"/>
          <key-binding alias="response" key="response"/>
          <key-binding alias="Basket" key="Basket"/>
          <key-binding alias="CurrentSession.custom.publicKey" key="publicKey"/>
          <key-binding alias="CurrentSession.custom.signature" key="signature"/>
          <key-binding alias="CurrentSession.custom.merchantId" key="merchantId"/>
          <key-binding alias="CurrentSession.custom.productId" key="productId"/>
          <key-binding alias="CurrentSession.custom.purchaseId" key="purchaseId"/>
          <key-binding alias="CurrentSession.custom.siteId" key="siteId"/>
          <key-binding alias="CurrentSession.custom.amount" key="amount"/>
        </pipelet-node>
        <node-display x="0" y="1"/>
        <branch basename="b4" source-connector="error">
          <transition target-connector="in1" target-path="./+1">
            <transition-display>
              <bend-point relative-to="source" x="2" y="0"/>
            </transition-display>
          </transition>
        </branch>
      </node>
      <simple-transition>
        <transition-display>
          <bend-point relative-to="source" x="0" y="1"/>
        </transition-display>
      </simple-transition>
      <node>
        <decision-node condition-key="ReasonCode == 100" condition-operator="expr">
          <description>Successful transaction.</description>
        </decision-node>
        <node-display x="0" y="1"/>
        <branch basename="b5" source-connector="yes">
          <transition target-connector="in">
            <transition-display>
              <bend-point relative-to="source" x="0" y="1"/>
            </transition-display>
          </transition>
          <segment>
            <node>
              <end-node name="success"/>
              <node-display x="0" y="1"/>
            </node>
          </segment>
        </branch>
      </node>
      <transition target-connector="in1" target-path="./+1"/>
    </segment>
    <segment>
      <node>
        <join-node/>
        <node-display x="1" y="0"/>
      </node>
      <simple-transition>
        <transition-display>
          <bend-point relative-to="source" x="0" y="1"/>
        </transition-display>
      </simple-transition>
      <node>
        <end-node name="error"/>
        <node-display x="0" y="1"/>
      </node>
    </segment>
  </branch>
</pipeline>
